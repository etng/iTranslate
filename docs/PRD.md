# iTranslate 产品需求文档（PRD）

## 1. 产品目标

构建一个本地优先的桌面翻译工具，默认基于 Ollama `translategemma`，支持格式保真翻译、历史可追溯、引擎可扩展，并提供适合长文处理的高密度工作界面。

## 2. 迭代后目标用户

- 需要私有化翻译的开发者、技术写作者、内容编辑者。
- 需要处理 Markdown/HTML 文档并要求结构尽量保留的用户。
- 需要将分章节译文导出为双语 EPUB 的用户。

## 3. 功能范围

### 3.1 当前版本范围（已实现）

- Tauri + React 桌面应用，中文界面。
- 首次启动向导：检测本地 Ollama 服务可达性与模型可用性。
- 翻译主流程：
  - 源语言/目标语言选择（默认英语 -> 简体中文）。
  - 输入区支持粘贴与手动输入。
  - 调用 `translategemma` 并返回结果。
- 输入处理策略：
  - `Cmd+V` 粘贴：自动探测 HTML 并转换为更规整的 Markdown 后翻译。
  - 手动键入：不自动翻译，由用户点击“马上翻译”触发。
  - 粘贴触发可防抖翻译。
- 结果展示：
  - Markdown（带行号编辑器视图）/HTML 预览双模式切换。
  - 双栏等宽展示，段落/块级对齐与联动阅读。
- 历史记录：
  - 表格分页（多页码跳转）。
  - 标题可编辑、记录可删除。
  - 支持从历史项回看与继续编辑重译（更新当前记录，不重复新增）。
  - 记录保留翻译引擎信息（引擎软删除后显示“已删除”状态）。
- 翻译引擎管理（表格化）：
  - 新增、编辑、启停、软删除、设为默认。
  - 支持不同字段（地址、模型、Token、用户名、密码、别名等）。
  - 无引擎时引导先配置；无默认引擎时翻译前必须选择。
- EPUB 导出：
  - 历史列表多选导出，向导配置参数。
  - 每条记录作为章节，默认按标题升序，可调整。
  - 修复 iBooks 兼容性（实体处理）。
  - 导出成功后 toast 提示。
- EPUB 闭环翻译：
  - 支持导入 `.epub`，自动提取章节 HTML/XHTML 并按翻译流程批量处理。
  - 每个章节结果写入历史，标题规则：`{epub文件名} ⟫ {html文件名}`。
  - 批量翻译完成后自动导出 `{epub文件名}_已翻译.epub`。
- 用户偏好：
  - 默认 EPUB 导出目录。
  - 默认 EPUB 作者。
- 菜单能力：
  - 关于（名称、简介、主要功能、版本）。
  - 检查更新（GitHub `releases/latest`）。
- 布局与交互：
  - 顶部紧凑工具栏。
  - 中间翻译区自适应占满剩余空间。
  - 底部状态/日志为折叠 Dock（默认折叠）并支持拖拽高度。
  - 控制页面级滚动，仅编辑器/预览区允许纵向滚动。
- 工程能力：
  - Makefile 统一命令入口（初始化、启动、测试、seed、版本等）。
  - 单元测试（Vitest）+ e2e（Playwright）持续校验。
  - GitHub Actions 自动发版：`v*` tag 触发构建并发布 Release（含安装包与 Updater 元数据）。

### 3.2 暂不纳入本期

- 云端账号体系与跨设备同步。
- UI 多语言（当前仅中文）。
- 全自动静默更新（当前为可确认更新流程）。

## 4. 核心业务规则

- 请求 `translategemma` 时，必须严格使用官方 prompt format（仅请求时拼接，不写入历史）。
- HTML 输入优先转换为 Markdown，再进入翻译流程。
- 打开历史详情不触发新翻译，不新增历史记录。
- 历史详情模式下语言选择器禁用，只显示该记录源/目标语言。
- 翻译记录必须落库并可追溯到使用的引擎与模型。
- 引擎删除采用软删除：不影响历史展示，但不可继续用于新翻译。

## 5. 数据模型（抽象）

### 5.1 翻译引擎

- 基础字段：`id`、`name`、`provider`、`endpoint`、`model`。
- 凭据字段：`token`、`username`、`password`（按需）。
- 状态字段：`enabled`、`deletedAt`、`isDefault`。

### 5.2 翻译记录

- 基础字段：`id`、`title`、`sourceLang`、`targetLang`、`sourceText`、`translatedText`。
- 引擎字段：`engineId`、`engineNameSnapshot`、`model`。
- 元数据：`createdAt`、`updatedAt`、`viewMode`（markdown/html）。

### 5.3 用户偏好

- `defaultExportDir`、`defaultEpubAuthor`、`uiState`（分页/折叠状态等）。

## 6. 更新与版本策略

- 版本格式：`主.次.补丁.构建号`（示例：`0.1.1.7`）。
- 比较规则：先比较前三段语义版本，再比较构建号。
- 更新源：GitHub `releases/latest`。
- 发布流程：打 tag 的同时创建 release，供客户端检查更新消费。

## 7. 质量要求

- 每次迭代必须同步任务池与 PRD，避免文档滞后。
- 持续执行 `lint`、单测、e2e、`cargo check`。
- 提交采用小步提交，便于回滚与审查。
- 保持模块化接口，便于后续接入更多翻译模型/服务商。

## 8. 验收标准

- 可在本机 Ollama 环境完成稳定翻译。
- `translategemma` prompt format 正确，接口可通。
- Markdown/HTML 双视图切换无布局错位，双栏可读性稳定。
- 历史分页、编辑、删除、重译更新路径完整可用。
- 引擎管理（增删改启停默认）全链路可用。
- EPUB 向导导出可在 iBooks 正常打开，且支持自定义保存目录与作者。
- 状态栏/日志可辅助定位翻译调用过程。
- 自动化测试与构建检查通过。
